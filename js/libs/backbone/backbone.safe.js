define(["underscore","backbonesrc"],function(){var e=this._,t=this.Backbone;if(!e||!t||!JSON)return;t.Safe=function(t,n,r){this._reload=r&&r.reload&&r.reload===!0,this.uid=t,this.context=n,this.isCollection=!n.set&&n.models&&n.add;var i={events:"add reset",emptyValue:"[]",reload:function(){n.add(this.getData())},toJSON:function(e){return e.collection.toJSON()}},s={events:"change",emptyValue:"{}",reload:function(){n.set(this.getData())},toJSON:function(e){return e.toJSON()}};e.extend(this,this.isCollection?i:s),this.ensureUID(),this._reload&&this.reload(),n.on(this.events,this.store,this)},t.Safe.prototype={ensureUID:function(){e.isNull(this.getData())&&this.create()},create:function(){this.storage().setItem(this.uid,this.emptyValue)},store:function(e){this.storage().setItem(this.uid,JSON.stringify(this.toJSON(e)))},storage:function(){return localStorage},getData:function(){return this._current=this.storage().getItem(this.uid),this._current?JSON.parse(this._current):this._current},reset:function(){this.create()},destroy:function(){this.storage().removeItem(this.uniqueID)}};var n=function(e){var n=e.safe.key?e.safe.key:e.safe,r=e.safe.options||{reload:!0};n&&e&&(e.safe=new t.Safe(n,e,r))},r=function(){t.trigger("extend:Model",{key:"safe",extension:n,initialize:function(){this.trigger("after:initialize")}}),t.trigger("extend:Collection",{key:"safe",extension:n,initialize:function(){this.trigger("after:initialize")}})};return{beam:r}});